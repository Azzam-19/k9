<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bukti Pembelian</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f6f8;
        font-family: "Arial", sans-serif;
        padding: 2rem;
      }
      .container {
        background-color: #fff;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        color: #2c3e50;
      }
      .table img {
        max-width: 60px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4">Bukti Pembelian</h2>
      <div id="userInfo" class="mb-4"></div>
      <h5>Daftar Produk:</h5>
      <div id="cartTable"></div>
      <div class="mt-4">
        <a href="index.html" class="btn btn-primary">Kembali ke Home</a>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const checkoutData = JSON.parse(localStorage.getItem("checkoutData"));
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        function formatRupiah(angka) {
          return "Rp " + angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        if (!checkoutData || cart.length === 0) {
          document.body.innerHTML =
            '<div class="container text-center"><h3>Data pembelian tidak ditemukan.</h3><a href="home.html" class="btn btn-secondary mt-3">Kembali ke Home</a></div>';
          return;
        }

        // Tampilkan informasi user
        const userInfo = `
        <p><strong>Nama:</strong> ${checkoutData.fullname}</p>
        <p><strong>Email:</strong> ${checkoutData.email}</p>
        <p><strong>Alamat:</strong> ${checkoutData.address}, ${checkoutData.city}, ${checkoutData.province} (${checkoutData.zip})</p>
        <p><strong>Metode Pembayaran:</strong> ${checkoutData.payment}</p>
      `;
        document.getElementById("userInfo").innerHTML = userInfo;

        // Tampilkan tabel produk
        let tableHTML = `
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Gambar</th>
              <th>Produk</th>
              <th>Harga</th>
              <th>Jumlah</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
      `;
        let total = 0;
        cart.forEach((item) => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          tableHTML += `
          <tr>
            <td><img src="${item.image}" alt="${item.name}"></td>
            <td>${item.name}</td>
            <td>${formatRupiah(item.price)}</td>
            <td>${item.quantity}</td>
            <td>${formatRupiah(subtotal)}</td>
          </tr>
        `;
        });
        tableHTML += `
        <tr>
          <td colspan="4" class="text-end"><strong>Total</strong></td>
          <td><strong>${formatRupiah(total)}</strong></td>
        </tr>
        </tbody>
      </table>`;
        document.getElementById("cartTable").innerHTML = tableHTML;

        // Tambahkan ke riwayat jika belum ditambahkan
        if (!localStorage.getItem("sudahTambahRiwayat")) {
          const riwayat =
            JSON.parse(localStorage.getItem("riwayatPembelian")) || [];
          const newEntry = {
            fullname: checkoutData.fullname,
            email: checkoutData.email,
            address: checkoutData.address,
            city: checkoutData.city,
            province: checkoutData.province,
            zip: checkoutData.zip,
            payment: checkoutData.payment,
            tanggal: new Date().toLocaleString(),
            items: cart,
          };
          riwayat.push(newEntry);
          localStorage.setItem("riwayatPembelian", JSON.stringify(riwayat));
          localStorage.setItem("sudahTambahRiwayat", "true");

          // Kosongkan data
          localStorage.removeItem("cart");
          localStorage.removeItem("checkoutData");
        }

        // Reset flag saat kembali ke home
        document
          .querySelector("a[href='home.html']")
          .addEventListener("click", function () {
            localStorage.removeItem("sudahTambahRiwayat");
          });
      });
    </script>
  </body>
</html>
